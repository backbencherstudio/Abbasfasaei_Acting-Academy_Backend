<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Twilio Call Test</title>
    <style>
      body { font-family: system-ui, sans-serif; padding: 16px; }
      video { width: 280px; height: 210px; background:#000; margin: 8px; }
      #peers { display: flex; flex-wrap: wrap; gap: 8px; }
      button { margin-right: 8px; }
      .log { font-family: ui-monospace, monospace; background:#111; color:#0f0; padding:8px; height:160px; overflow:auto; }
    </style>
  </head>
  <body>
    <h2>Twilio Video – Socket.IO Test</h2>

    <label>Conversation ID:
      <input id="conv" value="CONVERSATION_ID_HERE" size="40">
    </label>
    <br/><br/>
    <label>Your JWT:
      <input id="jwt" value="JWT_HERE" size="80">
    </label>

    <div style="margin:12px 0;">
      <button id="btn-join-conv">Join Conversation</button>
      <button id="btn-start-video">Start VIDEO call</button>
      <button id="btn-start-audio">Start AUDIO call</button>
      <button id="btn-join-call">Join Call</button>
      <button id="btn-end-call">End Call</button>
    </div>

    <div>
      <strong>Local:</strong> <video id="local" autoplay playsinline muted></video>
    </div>
    <div>
      <strong>Peers:</strong>
      <div id="peers"></div>
    </div>

    <h3>Logs</h3>
    <div class="log" id="log"></div>

    <!-- Socket.IO client -->
    <script src="http://localhost:4000/socket.io/socket.io.js"></script>
    <!-- Twilio Video SDK (latest 2.x) -->
    <script src="https://sdk.twilio.com/js/video/releases/2.27.0/twilio-video.min.js"></script>
    <script>
      const log = (...a) => {
        const el = document.getElementById('log');
        el.textContent += a.map(x => typeof x === 'string' ? x : JSON.stringify(x)).join(' ') + '\\n';
        el.scrollTop = el.scrollHeight;
        console.log(...a);
      };

      const peersDiv = document.getElementById('peers');
      const localVideo = document.getElementById('local');
      let room = null;

      function attachTrack(track, container) {
        const el = track.attach();
        el.style.width = '280px';
        el.style.height = '210px';
        container.appendChild(el);
      }

      function attachParticipant(participant) {
        const wrap = document.createElement('div');
        wrap.id = participant.sid;
        participant.tracks.forEach(pub => { if (pub.track) attachTrack(pub.track, wrap); });
        participant.on('trackSubscribed', track => attachTrack(track, wrap));
        participant.on('trackUnsubscribed', track => track.detach().forEach(el => el.remove()));
        peersDiv.appendChild(wrap);
      }

      function detachParticipant(participant) {
        const node = document.getElementById(participant.sid);
        if (node) node.remove();
      }

      async function connectWithToken(token, kind) {
        // getUserMedia is handled by Twilio SDK internally,
        // but we render our own local preview for comfort.
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ video: kind === 'VIDEO', audio: true });
          localVideo.srcObject = stream;
        } catch (e) {
          log('⚠️ mic/cam permission error:', e.message);
        }

        room = await Twilio.Video.connect(token, {
          name: `conv:${document.getElementById('conv').value}`,
          audio: true,
          video: (kind === 'VIDEO'),
        });

        log('✅ connected to Twilio room:', room.name);

        room.participants.forEach(p => attachParticipant(p));
        room.on('participantConnected', p => { log('peer connected', p.identity); attachParticipant(p); });
        room.on('participantDisconnected', p => { log('peer disconnected', p.identity); detachParticipant(p); });

        room.on('disconnected', () => {
          log('room disconnected');
          peersDiv.innerHTML = '';
        });
      }

      // --- Socket.IO bits ---
      let socket;

      function initSocket() {
        const jwt = document.getElementById('jwt').value.trim();
        socket = io('http://localhost:4000/ws', {
          auth: { token: jwt },
          transports: ['websocket'],
        });

        socket.on('connect', () => log('ws connected'));
        socket.on('connection:ok', p => log('connection:ok', p));
        socket.on('error', e => log('ws error', e));

        // Call flows
        socket.on('call:ring', payload => {
          log('📳 call:ring', payload);
          // UX: auto-show incoming UI; for testing we can auto-join
        });

        socket.on('call:started', async ({ token, roomName, kind }) => {
          log('call:started', { roomName });
          await connectWithToken(token, kind);
        });

        socket.on('call:joined', async ({ token, roomName }) => {
          log('call:joined', { roomName });
          await connectWithToken(token, 'VIDEO'); // use video by default for testing
        });

        socket.on('call:ended', p => {
          log('☎️ call:ended', p);
          if (room) room.disconnect();
        });

        socket.on('call:peer-join', p => log('peer joined (socket):', p));
      }

      // --- Buttons ---
      document.getElementById('btn-join-conv').onclick = () => {
        if (!socket) initSocket();
        const conversationId = document.getElementById('conv').value.trim();
        socket.emit('conversation:join', { conversationId });
        log('sent conversation:join', { conversationId });
      };

      document.getElementById('btn-start-video').onclick = () => {
        const conversationId = document.getElementById('conv').value.trim();
        socket.emit('call:start', { conversationId, kind: 'VIDEO' });
        log('sent call:start VIDEO');
      };

      document.getElementById('btn-start-audio').onclick = () => {
        const conversationId = document.getElementById('conv').value.trim();
        socket.emit('call:start', { conversationId, kind: 'AUDIO' });
        log('sent call:start AUDIO');
      };

      document.getElementById('btn-join-call').onclick = () => {
        const conversationId = document.getElementById('conv').value.trim();
        socket.emit('call:join', { conversationId });
        log('sent call:join');
      };

      document.getElementById('btn-end-call').onclick = () => {
        const conversationId = document.getElementById('conv').value.trim();
        socket.emit('call:end', { conversationId });
        log('sent call:end');
      };
    </script>
  </body>
</html>
